<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>minimc: Estimators</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
// https://stackoverflow.com/a/68528445/5101335
MathJax.Hub.Config({
  TeX: {
    equationNumbers: {
      autoNumber: "AMS"
    }
  }
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<!-- https://jothepro.github.io/doxygen-awesome-css/md_docs_extensions.html#autotoc_md18 -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<!-- https://jothepro.github.io/doxygen-awesome-css/md_docs_extensions.html#autotoc_md21 -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- https://jothepro.github.io/doxygen-awesome-css/md_docs_extensions.html#autotoc_md24 -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeParagraphLink.init()
</script>
<!-- https://jothepro.github.io/doxygen-awesome-css/md_docs_extensions.html#autotoc_md27 -->
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">minimc<span id="projectnumber">&#160;0.5.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('estimators.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Estimators </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#estimators_phase_space">Phase Space</a></li>
<li class="level1"><a href="#estimators_particle">Particle</a></li>
<li class="level1"><a href="#estimators_estimation">Estimation</a></li>
<li class="level1"><a href="#estimators_scoring_functions">Scoring Functions</a></li>
<li class="level1"><a href="#estimators_dos">Differential Operator Sampling</a><ul><li class="level2"><a href="#estimators_dos_direct">Direct Effect</a></li>
<li class="level2"><a href="#estimators_dos_indirect">Indirect Effect</a></li>
<li class="level2"><a href="#estimators_dos_pod_tnsl">Thermal Neutron Scattering Law</a><ul><li class="level3"><a href="#estimators_dos_pod_tnsl_Σ">Perturbing Σ</a></li>
<li class="level3"><a href="#estimators_dos_pod_tnsl_U">Perturbing U</a></li>
<li class="level3"><a href="#estimators_dos_pod_tnsl_V">Perturbing V</a></li>
<li class="level3"><a href="#estimators_dos_pod_tnsl_implementation">Implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="estimators_phase_space"></a>
Phase Space</h1>
<p >All steady-state particle transport occurs inside a multidimensional <em> phase space </em> which is characterized by a position \( \boldsymbol{x} \), direction-of-flight \( \hat{\boldsymbol{\Omega}} \), energy \( E \), and reaction label \( r \). Together, these form a random vector \( X \) for which one realization looks like  </p><p class="formulaDsp">
\[
  x_{i} =
  \begin{bmatrix}
    \boldsymbol{x}_{i} \\
    \hat{\boldsymbol{\Omega}}_{i} \\
    E_{i} \\
    r_{i}
  \end{bmatrix}
  \,\mathrm{.}
\]
</p>
<p> A realization of \( X_{i} \) (here denoted \( x_{i}) \) and a realizaton of position (here denoted \( \boldsymbol{x}_{i} \)) must not be confused with each other.</p>
<h1><a class="anchor" id="estimators_particle"></a>
Particle</h1>
<p >Fundamentally, a Monte Carlo radiation transport code is a simulation of a discrete random process \( \Omega = \left( X_{0}, X_{1}, X_{2}, \ldots \right)
\) for which we are interested in estimating the expected value of random variables \( S: \Omega \rightarrow \mathbb{R} \). At each step of a <em>history</em> \( \omega \in \Omega \), a <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> takes on some definite state in phase space \( X_{i} = x_{i} \). For this reason, the <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> class is heavily encapsulated and internally performs most of the operations required to update its state. Should other classes use a <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> object as a function parameter, they should only do so using a <code>const</code> qualifier. For instance, <a class="el" href="class_material.html#a6fdade2a30a2866ac8232b3abb8faf6f" title="Return the total microscopic cross section.">Material::GetMicroscopicTotal</a> accepts a <code>const</code> <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> reference as a parameter to look up relevant cross sections. Two notable exceptions, the <a class="el" href="class_interaction.html" title="Models the interaction between a Particle and a Nuclide.">Interaction</a> class and the <a class="el" href="class_transport_method.html" title="Performs the transport of a Particle after it is born up until its death.">TransportMethod</a> class, use non-<code>const</code> <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> arguments but still update a <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> state using its public methods.</p>
<h1><a class="anchor" id="estimators_estimation"></a>
Estimation</h1>
<p >An <em> <a class="el" href="class_estimator.html" title="Contains scores, multipliers, and sensitivities for a quantity of interest.">Estimator</a> </em> \( S: \Omega \rightarrow \mathbb{R} \) is a random variable which maps from a history \( \omega \in \Omega \) to a <em> score </em> \( s \in \mathbb{R} \). The expected value of an estimator is given by  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:estimator-expected-value}
  \mathbb{E} \left[ S \right]
  = \int_{\Omega} S\left( \omega \right) p_{\Omega}(\omega) \mathrm{d}\omega
    \,\mathrm{.}
\end{equation}
</p>
<p> When only \( N \) sampled values from \( \Omega \) are available, an estimate of the expected value is given by  </p><p class="formulaDsp">
\[
  \mathbb{E} \left[ S \right]
  \approx \sum_{n=1}^{N} S\left( \omega_{n} \right) \frac{1}{N}
  \,\mathrm{.}
\]
</p>
<h1><a class="anchor" id="estimators_scoring_functions"></a>
Scoring Functions</h1>
<p >In general an estimator is a function of all states that a <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> undergoes during transport \( S(\omega) = S(x_{1}, \ldots, x_{N}) \). However, a special class of estimators can be expressed  </p><p class="formulaDsp">
\[
  S(\omega) = \sum_{i} f(x_{i})
\]
</p>
<p> where the <em> scoring function </em> \( f: X \rightarrow \mathbb{R} \) is only a function of the \( i \)-th state. One example of a scoring function is  </p><p class="formulaDsp">
\[
  f(x_{i}) = \delta_{r_{i}, \text{scatter}}
\]
</p>
<p> which scores \( 1 \) if the particle underwent a scatter in step \( i \), zero otherwise. Using this scoring function results in an estimator for the total scatter rate. Another scoring function is  </p><p class="formulaDsp">
\[
  f(x_{i}) =
  \frac {\delta_{x_{i}, \text{capture}} + \delta_{x_{i}, \text{scatter}}}
        {\Sigma_{t}(x_{i})}
\]
</p>
<p> which scores \( \Sigma^{-1}_{t}(x_{i}) \) whenever a <a class="el" href="class_particle.html" title="The primary entity performing random walks in a World.">Particle</a> collides. Using this scoring funtion results in an estimator for the scalar flux.</p>
<h1><a class="anchor" id="estimators_dos"></a>
Differential Operator Sampling</h1>
<p >When a perturbation to a Monte Carlo problem is introduced, the expected value of an <a class="el" href="class_estimator.html" title="Contains scores, multipliers, and sensitivities for a quantity of interest.">Estimator</a> \( \mathbb{E} [S] \) will generally change. Examples of perturbations include shifts in a geometric configuration or changes in a <a class="el" href="class_nuclide.html" title="Aggregates cross sections for all reactions and related nuclear data.">Nuclide</a> cross section, to name a few.</p>
<p >If a system parameter is parameterized by \( \lambda \), the change in the expected value can be expressed as  </p><p class="formulaDsp">
\[
  \frac{\mathrm{d} \mathbb{E} \left[ S \right]}{\mathrm{d}\lambda}
  = \int_{\Omega}
      \left[
        \frac{1}{S\left( \omega \right)}
        \frac{\mathrm{d}S\left( \omega \right)}{\mathrm{d}\lambda}
        +
        \frac{1}{p_{\Omega}(\omega)}
        \frac{\mathrm{d}p_{\Omega}(\omega)}{\mathrm{d}\lambda}
      \right]
      S\left( \omega \right) p_{\Omega}(\omega) \mathrm{d}\omega
    \,\mathrm{.}
\]
</p>
<p >This form is identical to \( \eqref{eq:estimator-expected-value} \) if one makes the substitution  </p><p class="formulaDsp">
\[
  S\left( \omega \right)
  \rightarrow
  \left[
    \frac{1}{S\left( \omega \right)}
    \frac{\mathrm{d}S\left( \omega \right)}{\mathrm{d}\lambda}
    +
    \frac{1}{p_{\Omega}(\omega)}
    \frac{\mathrm{d}p_{\Omega}(\omega)}{\mathrm{d}\lambda}
  \right]
  S\left( \omega \right)
  \,\mathrm{.}
\]
</p>
<p >The first term in the square bracketes is called the <em>direct effect</em> and the second term is called the <em>indirect effect</em>.</p>
<h2><a class="anchor" id="estimators_dos_direct"></a>
Direct Effect</h2>
<p >The direct effect  </p><p class="formulaDsp">
\[
  \frac{1}{S\left( \omega \right)}
  \frac{\mathrm{d}S\left( \omega \right)}{\mathrm{d}\lambda}
\]
</p>
<p> reflects the change in how \( S \) maps from the history space \( \Omega \) to the score space \( \mathbb{R} \). It must be provided as a function depending on the particular type of perturbation.</p>
<h2><a class="anchor" id="estimators_dos_indirect"></a>
Indirect Effect</h2>
<p >The indirect effect  </p><p class="formulaDsp">
\[
  \frac{1}{p_{\Omega}(\omega)}
  \frac{\mathrm{d}p_{\Omega}(\omega)}{\mathrm{d}\lambda}
\]
</p>
<p> reflects the change in the probability of sampling a history \( \omega \). If \( \omega = \left( x_{0}, x_{1}, x_{2}, \ldots \right) \) is Markovian, the probability of sampling a history can be expressed  </p><p class="formulaDsp">
\[
  p_{\Omega}(\omega)
  =
  p_{X_{0}} \left( x_{0} \right)
  p_{X_{1} \mid X_{0}} \left( x_{1} \mid x_{0} \right)
  p_{X_{2} \mid X_{1}} \left( x_{2} \mid x_{1} \right)
  \ldots
\]
</p>
<p> so repeated application of the product rule gives for the indirect effect  </p><p class="formulaDsp">
\[
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{\Omega}(\omega)}
    {p_{\Omega}(\omega)}
  =
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{X_{0}}(x_{0})}
    {p_{X_{0}}(x_{0})}
  +
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{X_{1} \mid X_{0}}(x_{1} \mid x_{0})}
    {p_{X_{1} \mid X_{0}}(x_{1} \mid x_{0})}
  +
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{X_{2} \mid X_{1}}(x_{2} \mid x_{1})}
    {p_{X_{2} \mid X_{1}}(x_{2} \mid x_{1})}
  +
  \ldots
\]
</p>
<p> The transition probabilities are conventionally decomposed  </p><p class="formulaDsp">
\begin{align*}
  \label{eq:transmission-emergence-kernel}
  p_{X_{i+1} \mid X_{i}} \left( x_{i+1} \middle| x_{i} \right)
  &amp;=
  p
    \left(
      \boldsymbol{x}_{i+1}
      \hat{\boldsymbol{\Omega}}_{i+1}
      E_{i+1},
      r_{i+1}
    \middle|
      \boldsymbol{x}_{i},
      \hat{\boldsymbol{\Omega}}_{i},
      E_{i},
      r_{i}
    \right)
  \\
  &amp;=
  p
    \left(
      \boldsymbol{x}_{i+1}
    \middle|
      \boldsymbol{x}_{i},
      \hat{\boldsymbol{\Omega}}_{i},
      E_{i},
      r_{i}
    \right)
  \\
  &amp;\quad\times
  p \left(
      r_{i+1}
    \middle|
      \boldsymbol{x}_{i+1}
      \hat{\boldsymbol{\Omega}}_{i},
      E_{i},
      r_{i}
    \right)
  \\
  &amp;\quad\times
  p \left(
      E_{i+1}
    \middle|
      \boldsymbol{x}_{i+1}
      \hat{\boldsymbol{\Omega}}_{i},
      E_{i},
      r_{i+1}
    \right)
  \\
  &amp;\quad\times
  p \left(
      \hat{\boldsymbol{\Omega}}_{i+1},
    \middle|
      \boldsymbol{x}_{i+1}
      \hat{\boldsymbol{\Omega}}_{i},
      E_{i+1},
      r_{i+1}
    \right)
  \\
  &amp;=
  \mathcal{T}_{i} \times \mathcal{R}_{i} \times \mathcal{E}_{i} \times \mathcal{A}_{i}
\end{align*}
</p>
<p> where the four terms on the righthand side are, in order,</p><ol type="1">
<li>\( \mathcal{T}_{i} \): The probability of streaming from \(
   \boldsymbol{x}_{i} \) then colliding at \( \boldsymbol{x}_{i+1} \),</li>
<li>\( \mathcal{R}_{i} \): The probability that a particle colliding at \(
   \boldsymbol{x}_{i+1} \) undergoes reaction \( r_{i+1} \),</li>
<li>\( \mathcal{E}_{i} \): The probability that a particle undergoing reaction \( r_{i+1} \) emerges with energy \( E_{i+1} \), and</li>
<li>\( \mathcal{A}_{i} \): The probability that a particle emerging with energy \( E_{i+1} \) emerges with direction \(
   \hat{\boldsymbol{\Omega}}_{i+1} \).</li>
</ol>
<p >Although the conditional probabilities could be selected in any order, the particular choice above corresponds to the order that each portion of phase space is actually sampled. Again using repeated application of the product rule, the indirect effect at step \( i \) is  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:step-i-indirect-effect}
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{X_{i+1} \mid X_{i}}(x_{i+1} \mid x_{i})}
    {p_{X_{i+1} \mid X_{i}}(x_{i+1} \mid x_{i})}
  =
  \frac
    { \frac{\mathrm{d}}{\mathrm{d}\lambda} \mathcal{T_{i}} }
    { \mathcal{T_{i}} }
  +
  \frac
    { \frac{\mathrm{d}}{\mathrm{d}\lambda} \mathcal{R_{i}} }
    { \mathcal{R_{i}} }
  +
  \frac
    { \frac{\mathrm{d}}{\mathrm{d}\lambda} \mathcal{E_{i}} }
    { \mathcal{E_{i}} }
  +
  \frac
    { \frac{\mathrm{d}}{\mathrm{d}\lambda} \mathcal{A_{i}} }
    { \mathcal{A_{i}} }
  \mathrm{.}
\end{equation}
</p>
<h2><a class="anchor" id="estimators_dos_pod_tnsl"></a>
Thermal Neutron Scattering Law</h2>
<p >When using partitioned thermal neutron scattering law data compressed using proper orthogonal decomposition, the parameters to be perturbed are \( u_{mr}
\), \( \sigma_{r} \), or \( v_{nr} \). The following discussion considers perturbations of parameters that are used to sample \( \alpha \).</p>
<p >Given a sampled value of \( \beta \), a target temperature \( T \), and uniformly sampled \( \xi \in \left[ 0, 1 \right) \), the sampling scheme (based on ENDF Law 4) first identifies indices \( k^{\prime} \), \(
l^{\prime} \), and \( m^{\prime} \) such that  </p><p class="formulaDsp">
\[
  \begin{alignat*}{3}
    &amp; \beta_{k^{\prime}-1}
    &amp;&amp; \leq \lvert \beta \rvert
    &amp;&amp; &lt; \beta_{k^{\prime}} \,\mathrm{,}\quad
    &amp;&amp; k^{\prime} \in \left\{ 1, \ldots, k \right\}
    \\
    &amp; T_{l^{\prime} - 1}
    &amp;&amp; \leq T
    &amp;&amp; &lt; T_{l^{\prime}} \,\mathrm{,}\quad
    &amp;&amp; l^{\prime} \in \left\{ 1, \ldots, l \right\}
    \\
    &amp; \hat{H}_{m^{\prime}-1}
    &amp;&amp; \leq \xi
    &amp;&amp; &lt; \hat{H}_{m^{\prime}} \,\mathrm{,}\quad
    &amp;&amp; m^{\prime} \in \left\{ 1, \ldots, m \right\}
  \end{alignat*}
\]
</p>
<p> are satisfied. Then, \( \tilde{k} \) is randomly assigned to either \(
k^{\prime} - 1 \) or \( k^{\prime} \). Defining the flattened index  </p><p class="formulaDsp">
\[
  n^{\prime} \equiv \left( \tilde{k} - 1 \right) l + l^{\prime}
\]
</p>
<p> and interpolation fractions  </p><p class="formulaDsp">
\[
  f_{T}
  =
  \frac
    {T - T_{l^{\prime} - 1}}
    {T_{l^{\prime}} - T_{l^{\prime} - 1}}
  \quad\mathrm{and}\quad
  f_{\hat{H}}
  =
  \frac
    {\xi - \hat{H}_{m^{\prime} - 1}}
    {\hat{H}_{m^{\prime}} - \hat{H}_{m^{\prime} - 1}}
  \,\mathrm{,}
\]
</p>
<p> the sampled value of \( \alpha \) is obtained through bilinear interpolation in temperature and <a class="el" href="class_c_d_f.html" title="Like Map, but stores elements as the CDF of some random variable. Stores CDF values as keys so that s...">CDF</a>:  </p><p class="formulaDsp">
\[
  \alpha_{\tilde{k}}
  =
  \begin{bmatrix}
    1-f_{\hat{H}} &amp; f_{\hat{H}}
  \end{bmatrix}
  \begin{bmatrix}
    \alpha_{m^{\prime} - 1, n^{\prime} - 1} &amp; \alpha_{m^{\prime} - 1, n^{\prime}} \\
    \alpha_{m^{\prime}, n^{\prime} - 1}     &amp; \alpha_{m^{\prime}, n^{\prime}}
  \end{bmatrix}
  \begin{bmatrix}
    1-f_{T} \\
    f_{T}
  \end{bmatrix}
  \equiv
  \vec{f}_{\hat{H}}^{T} A_{m^{\prime}n^{\prime}} \vec{f}_{T}
\]
</p>
<p> where \( A_{m^{\prime}n^{\prime}} \) is a \( 2 \times 2 \) matrix dependent on \( m^{\prime} \) and \( n^{\prime} \) and should not be mistaken for a single element. Linear interpolation in <a class="el" href="class_c_d_f.html" title="Like Map, but stores elements as the CDF of some random variable. Stores CDF values as keys so that s...">CDF</a> implies that the PDF is a histogram  </p><p class="formulaDsp">
\[
  p\left( \alpha_{\tilde{k}} \right)
  =
  \frac
    {\Delta \hat{H}}
    {\Delta \alpha}
  =
  \frac
    {\hat{H}_{m^{\prime}} - \hat{H}_{m^{\prime}-1}}
    {
      \vec{d}^{T}
      A_{m^{\prime}n^{\prime}}
      \vec{f}_{T}
    }
\]
</p>
<p> where \( \vec{d}^{T} = \begin{bmatrix} -1 &amp; +1 \end{bmatrix} \) is a row vector which takes the difference between the first and second elements of \(
A_{m^{\prime}n^{\prime}} \vec{f}_{T} \). Setting \( \lambda \) to any of \(
u_{m^{\prime}r^{\prime}} \), \( \sigma_{r^{\prime}} \), or \(
v_{n^{\prime}r^{\prime}} \) will only affect the terms inside \(
A_{m^{\prime}n^{\prime}} \) so the derivative becomes  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:derivative-alpha-probability}
  \frac
    {\mathrm{d}p\left( \alpha_{\tilde{k}} \right)}
    {\mathrm{d}\lambda}
  =
  -p\left( \alpha_{\tilde{k}} \right)
  \frac
    {
      \vec{d}^{T}
      \left(
        \frac
          {\mathrm{d}}
          {\mathrm{d}\lambda}
          A_{m^{\prime}n^{\prime}}
      \right)
      \vec{f}_{T}
    }
    {
      \vec{d}^{T}
      A_{m^{\prime}n^{\prime}}
      \vec{f}_{T}
    }
  \,\textrm{.}
\end{equation}
</p>
<p >The last steps in sampling direction cosine \( \mu \) are unit base interpolation followed by conversion from dimensionless momentum transfer \(
\alpha \) to \( \mu \). Unit base interpolation is the transformation  </p><p class="formulaDsp">
\[
  \alpha(\beta)
  =
  \alpha_{\min}(\beta)
  +
  \frac
    {\alpha_{\tilde{k}} - \alpha_{\tilde{k}, \min}}
    {\alpha_{\tilde{k}, \max} - \alpha_{\tilde{k}, \min}}
  \left(
    \alpha_{\max}(\beta) - \alpha_{\min}(\beta)
  \right)
\]
</p>
<p> mapping \( \alpha_{\tilde{k}} \in \left[ \alpha_{\tilde{k}, \min},
\alpha_{\tilde{k}, \max} \right] \) to \( \alpha \left( \beta \right) \in
\left[ \alpha_{\min}(\beta), \alpha_{\max}(\beta) \right] \) so that the thresholds at the actual value of \( \beta \) are preserved. The transformation  </p><p class="formulaDsp">
\[
  \mu
  =
  \frac
    {E + E^{\prime} - \alpha A k_{\mathrm{B}} T}
    {2 \sqrt{E E^{\prime}}}
\]
</p>
<p> maps from \( \alpha \left( \beta \right) \in \left[ \alpha_{\min}(\beta),
\alpha_{\max}(\beta) \right] \) to \( \mu \in \left[ -1, +1 \right] \), the scattering cosine used in transport. Using appropriate Jacobians, the probability of sampling \( \mu \) is  </p><p class="formulaDsp">
\[
  p \left( \mu \right)
  =
  p \left( \alpha_{\tilde{k}} \right)
  \left|
    \frac
      {\mathrm{d} \alpha_{\tilde{k}}}
      {\mathrm{d} \alpha \left( \beta \right)}
  \right|
  \left|
    \frac
      {\mathrm{d} \alpha \left( \beta \right)}
      {\mathrm{d} \mu}
  \right|
  =
  p \left( \alpha_{\tilde{k}} \right)
  \frac
    {\alpha_{\tilde{k}, \max} - \alpha_{\tilde{k}, \min}}
    {\alpha_{\max}(\beta) - \alpha_{\min}(\beta)}
  \frac
    {2 \sqrt{E E^{\prime}}}
    {A k_{\mathrm{B}} T}
  \,\mathrm{.}
\]
</p>
<p> If the Jacobians are independent of the perturbed quantity \( \lambda \), we have  </p><p class="formulaDsp">
\[
  \frac
    {\mathrm{d} p \left( \mu \right)}
    {\mathrm{d} \lambda}
  =
  \frac
    {\mathrm{d} p \left( \alpha_{\tilde{k}} \right)}
    {\mathrm{d} \lambda}
  \left|
    \frac
      {\mathrm{d} \alpha_{\tilde{k}}}
      {\mathrm{d} \alpha \left( \beta \right)}
  \right|
  \left|
    \frac
      {\mathrm{d} \alpha \left( \beta \right)}
      {\mathrm{d} \mu}
  \right|
\]
</p>
<p> so \( \eqref{eq:derivative-alpha-probability} \) can be expressed  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:log-derivative-alpha-probability}
  \frac
    {1}
    {p\left( \mu \right)}
  \frac
    {\mathrm{d}p\left( \mu \right)}
    {\mathrm{d}\lambda}
  =
  \frac
    {1}
    {p\left( \alpha_{\tilde{k}} \right)}
  \frac
    {\mathrm{d}p\left( \alpha_{\tilde{k}} \right)}
    {\mathrm{d}\lambda}
  =
  -
  \frac
    {
      \vec{d}^{T}
      \left(
        \frac
          {\mathrm{d}}
          {\mathrm{d}\lambda}
          A_{m^{\prime}n^{\prime}}
      \right)
      \vec{f}_{T}
    }
    {
      \vec{d}^{T}
      A_{m^{\prime}n^{\prime}}
      \vec{f}_{T}
    }
  \,\mathrm{.}
\end{equation}
</p>
<p> The following discussions on perturbations in \( u_{mr} \), \( \sigma_{r}
\), or \( v_{nr} \) will refer to the matrix in the numerator of \(
\eqref{eq:log-derivative-alpha-probability} \)  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:derivative-alpha-matrix}
  \frac{\mathrm{d}}{\mathrm{d}\lambda}
  A_{m^{\prime}n^{\prime}}
  =
  \begin{bmatrix}
    \frac{\mathrm{d}}{\mathrm{d}\lambda}
    \alpha_{m^{\prime}-1,n^{\prime}-1}
    &amp;
    \frac{\mathrm{d}}{\mathrm{d}\lambda}
    \alpha_{m^{\prime}-1,n^{\prime}}
    \\
    \frac{\mathrm{d}}{\mathrm{d}\lambda}
    \alpha_{m^{\prime},n^{\prime}-1}
    &amp;
    \frac{\mathrm{d}}{\mathrm{d}\lambda}
    \alpha_{m^{\prime},n^{\prime}}
  \end{bmatrix}
\end{equation}
</p>
<p> where each matrix element in \( \eqref{eq:derivative-alpha-matrix} \) is  </p><p class="formulaDsp">
\begin{equation}
  \label{eq:derivative-alpha}
  \frac
    {\mathrm{d}}
    {\mathrm{d}\lambda}
  \alpha_{m^{\prime}n^{\prime}}
  =
  \sum_{r^{\prime}=1}^{r}
  \frac
    {\mathrm{d}}
    {\mathrm{d}\lambda}
  u_{m^{\prime}r^{\prime}} \sigma_{r^{\prime}} v_{n^{\prime}r^{\prime}}
  \,\mathrm{.}
\end{equation}
</p>
<h3><a class="anchor" id="estimators_dos_pod_tnsl_Σ"></a>
Perturbing Σ</h3>
<p >Setting \( \lambda = \sigma_{r} \), \( \eqref{eq:derivative-alpha} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {\mathrm{d}}
    {\mathrm{d}\sigma_{r}}
  \alpha_{m^{\prime}n^{\prime}}
  =
  \sum_{r^{\prime}=1}^{r}
  \frac
    {\mathrm{d}}
    {\mathrm{d}\sigma_{r}}
  u_{m^{\prime}r^{\prime}} \sigma_{r^{\prime}} v_{n^{\prime}r^{\prime}}
  =
  u_{m^{\prime}r^{\prime}}v_{n^{\prime}r^{\prime}}\delta_{r,r^{\prime}}
  \,\textrm{.}
\]
</p>
<p> Defining  </p><p class="formulaDsp">
\[
  \vec{u}_{m^{\prime}r}
  \equiv
  \begin{bmatrix}
    u_{m^{\prime}-1,r} \\
    u_{m^{\prime}, r}
  \end{bmatrix}
  \quad\mathrm{and}\quad
  \vec{v}_{n^{\prime}r}
  \equiv
  \begin{bmatrix}
    v_{n^{\prime}-1,r} \\
    v_{n^{\prime}, r}
  \end{bmatrix}
  \,\mathrm{,}
\]
</p>
<p> \( \eqref{eq:derivative-alpha-matrix} \) becomes  </p><p class="formulaDsp">
\[
  \frac{\mathrm{d}}{\mathrm{d}\sigma_{r}}
  A_{m^{\prime}n^{\prime}}
  =
  \begin{bmatrix}
    u_{m^{\prime}-1,r}v_{n^{\prime}-1,r}
    &amp;
    u_{m^{\prime}-1,r}v_{n^{\prime},r}
    \\
    u_{m^{\prime},r}v_{n^{\prime}-1,r}
    &amp;
    u_{m^{\prime},r}v_{n^{\prime},r}
  \end{bmatrix}
  =
  \vec{u}_{m^{\prime}r} \vec{v}_{n^{\prime}r}^{T}
\]
</p>
<p> so \( \eqref{eq:log-derivative-alpha-probability} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {1}
    {p\left( \mu \right)}
  \frac
    {\mathrm{d}p\left( \mu \right)}
    {\mathrm{d}\sigma_{r}}
  =
  -
  \frac
    {\vec{d}^{T} \vec{u}_{m^{\prime}r} \vec{v}_{n^{\prime}r}^{T} \vec{f}_{T} }
    {\vec{d}^{T} A_{m^{\prime}n^{\prime}} \vec{f}_{T} }
  \,\mathrm{.}
\]
</p>
<h3><a class="anchor" id="estimators_dos_pod_tnsl_U"></a>
Perturbing U</h3>
<p >Setting \( \lambda = u_{mr} \), \( \eqref{eq:derivative-alpha} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {\mathrm{d}}
    {\mathrm{d}u_{mr}}
  \alpha_{m^{\prime}n^{\prime}}
  =
  \sum_{r^{\prime}=1}^{r}
  \frac
    {\mathrm{d}}
    {\mathrm{d}u_{mr}}
  u_{m^{\prime}r^{\prime}} \sigma_{r^{\prime}} v_{n^{\prime}r^{\prime}}
  =
  \sigma_{r^{\prime}} v_{n^{\prime}r^{\prime}} \delta_{m,m^{\prime}} \delta_{r,r^{\prime}}
  \,\textrm{.}
\]
</p>
<p> The only nonzero cases of \( \eqref{eq:derivative-alpha-matrix} \) that get used are  </p><p class="formulaDsp">
\begin{cases}
  \frac{\mathrm{d}}{\mathrm{d}u_{mr}}
  A_{m,n}
  =&amp;
  \begin{bmatrix}
    0 &amp; 0 \\
    \sigma_{r} v_{n-1,r} &amp;
    \sigma_{r} v_{n,r}
  \end{bmatrix}
  \,\mathrm{,}
  &amp;
  \hat{H}_{m-1} \leq \xi &lt; \hat{H}_{m}
  \\
  \frac{\mathrm{d}}{\mathrm{d}u_{mr}}
  A_{m+1,n}
  =&amp;
  \begin{bmatrix}
    \sigma_{r} v_{n-1,r} &amp;
    \sigma_{r} v_{n,r} \\
    0 &amp; 0
  \end{bmatrix}
  \,\mathrm{,}
  &amp;
  \hat{H}_{m} \leq \xi &lt; \hat{H}_{m+1}
  \,\mathrm{.}
\end{cases}
</p>
<p >Recalling that \( \vec{d}^{T} = \begin{bmatrix} -1 &amp; +1 \end{bmatrix} \), and defining  </p><p class="formulaDsp">
\[
  C \left( \xi \right)
  \equiv
  \begin{cases}
  +1 &amp; \hat{H}_{m-1} \leq \xi &lt; \hat{H}_{m} \\
  -1 &amp; \hat{H}_{m} \leq \xi &lt; \hat{H}_{m+1} \\
  0  &amp; \mathrm{otherwise,}
  \end{cases}
\]
</p>
<p> we have  </p><p class="formulaDsp">
\[
  \vec{d}^{T}
  \left( \frac{\mathrm{d}}{\mathrm{d}u_{mr}} A_{m^{\prime}n^{\prime}} \right)
  =
  C \left( \xi \right)
  \sigma_{r}
  \vec{v}_{n^{\prime}r}^{T}
\]
</p>
<p> so \( \eqref{eq:log-derivative-alpha-probability} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {1}
    {p\left( \mu \right)}
  \frac
    {\mathrm{d}p\left( \mu \right)}
    {\mathrm{d}u_{mr}}
  =
  -C \left( \xi \right)
  \frac
    {\sigma_{r} \vec{v}_{n^{\prime}r}^{T} \vec{f}_{T}}
    {\vec{d}^{T} A_{m^{\prime}n^{\prime}} \vec{f}_{T}}
  \,\textrm{.}
\]
</p>
<h3><a class="anchor" id="estimators_dos_pod_tnsl_V"></a>
Perturbing V</h3>
<p >Setting \( \lambda = v_{nr} \), \( \eqref{eq:derivative-alpha} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {\mathrm{d}}
    {\mathrm{d}v_{nr}}
  \alpha_{m^{\prime}n^{\prime}}
  =
  \sum_{r^{\prime}=1}^{r}
  \frac
    {\mathrm{d}}
    {\mathrm{d}v_{nr}}
  u_{m^{\prime}r^{\prime}} \sigma_{r^{\prime}} v_{n^{\prime}r^{\prime}}
  =
  u_{m^{\prime}r^{\prime}} \sigma_{r^{\prime}} \delta_{r,r^{\prime}} \delta_{n,n^{\prime}}
  \,\textrm{.}
\]
</p>
<p >The only nonzero cases of \( \eqref{eq:derivative-alpha-matrix} \) that get used are  </p><p class="formulaDsp">
\begin{cases}
  \frac{\mathrm{d}}{\mathrm{d}v_{nr}}
  A_{m,n}
  =&amp;
  \begin{bmatrix}
    0 &amp; u_{m-1,r} \sigma_{r} \\
    0 &amp; u_{m,r} \sigma_{r}
  \end{bmatrix}
  \,\mathrm{,}
  &amp;
  T_{l^{\prime} - 1} \leq T &lt; T_{l^{\prime}}
  \\
  \frac{\mathrm{d}}{\mathrm{d}v_{nr}}
  A_{m,n+1}
  =&amp;
  \begin{bmatrix}
    u_{m-1,r} \sigma_{r} &amp; 0 \\
    u_{m,r} \sigma_{r} &amp; 0
  \end{bmatrix}
  \,\mathrm{,}
  &amp;
  T_{l^{\prime}} \leq T &lt; T_{l^{\prime} + 1}
\end{cases}
</p>
<p> with the additional condition that \( n = \left( \tilde{k} - 1 \right) l +
l^{\prime} \). In other words, the \( n \) index of the perturbed \( v_{nr}
\) must also coincide with the randomly sampled \( \beta \) index \(
\tilde{k} \).</p>
<p >Recalling that \( \vec{f_{T}}^{T} = \begin{bmatrix} 1-f_{T} &amp; f_{T}
\end{bmatrix} \), and defining  </p><p class="formulaDsp">
\[
  B_{n^{\prime}} \left( T \right)
  \equiv
  \begin{cases}
    f_{T} &amp;
    T_{l^{\prime} - 1} \leq T &lt; T_{l^{\prime}}
    \quad\mathrm{and}\quad
    \left\lfloor \frac{n^{\prime} - 1}{l} \right\rfloor + 1 = \tilde{k}
    \\
    1-f_{T} &amp;
    T_{l^{\prime}} \leq T &lt; T_{l^{\prime} + 1}
    \quad\mathrm{and}\quad
    \left\lfloor \frac{n^{\prime} - 1}{l} \right\rfloor + 1 = \tilde{k}
    \\
    0 &amp; \mathrm{otherwise,}
  \end{cases}
\]
</p>
<p> we have  </p><p class="formulaDsp">
\[
  \left( \frac{\mathrm{d}}{\mathrm{d}v_{nr}} A_{m^{\prime}n^{\prime}} \right)
  \vec{f}_{T}
  =
  B_{n^{\prime}} \left( T \right)
  \sigma_{r}
  \vec{u}_{m^{\prime}r}
\]
</p>
<p> so \( \eqref{eq:log-derivative-alpha-probability} \) becomes  </p><p class="formulaDsp">
\[
  \frac
    {1}
    {p\left( \mu \right)}
  \frac
    {\mathrm{d}p\left( \mu \right)}
    {\mathrm{d}v_{nr}}
  =
  -B_{n^{\prime}} \left( T \right)
  \frac
    {\sigma_{r} \vec{d}^{T} \vec{u}_{m^{\prime}r}}
    {\vec{d}^{T} A_{m^{\prime}n^{\prime}} \vec{f}_{T}}
  \,\textrm{.}
\]
</p>
<h3><a class="anchor" id="estimators_dos_pod_tnsl_implementation"></a>
Implementation</h3>
<p >When only perturbations in \( u_{mr} \), \( \sigma_{r} \), or \( v_{nr}
\) for \( \alpha \) <a class="el" href="class_c_d_f.html" title="Like Map, but stores elements as the CDF of some random variable. Stores CDF values as keys so that s...">CDF</a> data are considered, the only nonzero term in \(
\eqref{eq:step-i-indirect-effect} \) is  </p><p class="formulaDsp">
\[
  \mathcal{E}_{i}
  =
  p
  \left(
    \hat{\boldsymbol{\Omega}}_{i+1},
  \middle|
    \boldsymbol{x}_{i+1}
    \hat{\boldsymbol{\Omega}}_{i},
    E_{i+1},
    r_{i+1}
  \right)
  =
  \frac{1}{2\pi}
  p
  \left(
    \mu_{i+1}
  \middle|
    \boldsymbol{x}_{i+1}
    E_{i+1},
    r_{i+1}
  \right)
\]
</p>
<p> so we have  </p><p class="formulaDsp">
\[
  \frac
    {\frac{\mathrm{d}}{\mathrm{d}\lambda} p_{X_{i+1} \mid X_{i}}(x_{i+1} \mid x_{i})}
    {p_{X_{i+1} \mid X_{i}}(x_{i+1} \mid x_{i})}
  =
  \frac
    {1}
    {p\left( \mu \right)}
  \frac
    {\mathrm{d}p\left( \mu \right)}
    {\mathrm{d}\lambda}
  \,\mathrm{.}
\]
</p>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
